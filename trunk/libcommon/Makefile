ROOT_DIR = $(shell readlink -f ../)
include ../Rules.mk

AR = ar
PERFCTR_DIR = ../perfctr
INCLUDES += -I$(PERFCTR_DIR)/linux/include/ -I$(PERFCTR_DIR)/usr.lib/ -I../ -I../VEX/pub/
ARFLAGS = rv
ASM_OFFSETS = asm-offsets
CSOURCES = netops.c fdops.c debug.c sysnames.c errops.c hexops.c segops.c ringbuffer.c

ifeq ($(LIBC), glibc)
OBJDIR = $(BUILD_DIR)/libcommon_glibc
CFLAGS += $(INCLUDES) -DUSING_DIET_LIBC=0
TARGET = $(OBJDIR)/libcommon.a
CSOURCES += child.c hijack.c
else
OBJDIR = $(BUILD_DIR)/libcommon
CFLAGS += -nostdinc $(INCLUDES) -DUSING_DIET_LIBC=1 -DCG_SLOW_WRITE=1
INCLUDES += -I../dietlibc-0.30/include
TARGET = $(OBJDIR)/libcommon.a
CSOURCES += misc.c clock.c memops.c syncops.c shmalloc.c sharedarea.c usercopy.c pin.c sigops.c pmcops.c iovops.c brpred.c linux.c tsocket.c
endif


all: $(ASM_OFFSETS).h $(TARGET)
-include depend



ASMSOURCES = syscall.S context.S spinlock.S

COBJECTS = $(CSOURCES:%.c=$(OBJDIR)/%.o)
ASMOBJECTS = $(ASMSOURCES:%.S=$(OBJDIR)/%.o)

$(ASM_OFFSETS).h:
	$(CC) $(CFLAGS) -S $(ASM_OFFSETS).c
	( set -e; \
		echo "#pragma once"; \
		echo "/*"; \
		echo " * DO NOT MODIFY."; \
		echo " *"; \
		echo " * This file was generated by Makefile"; \
		echo " *"; \
		echo " */"; \
		echo ""; \
		sed -ne "/#define/p" $(ASM_OFFSETS).s $<; \
		) > $@
	rm $(ASM_OFFSETS).s


$(TARGET): $(COBJECTS) $(ASMOBJECTS)
	$(AR) $(ARFLAGS) $@ $(COBJECTS) $(ASMOBJECTS)

$(OBJDIR)/%.o : %.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -c $< -o $@

$(OBJDIR)/%.o : %.S
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -c $< -o $@


clean:
	rm -fr $(OBJDIR)
	rm -f $(ASM_OFFSETS).h depend

depend:
	gcc $(CFLAGS) -MM $(CSOURCES) > depend
